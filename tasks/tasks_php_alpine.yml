---

  - name: Prepare for install
    shell: "apk update && apk upgrade && apk add --update tzdata && echo '{{timezone}}' > /etc/timezone"

  - debug: var="php_extensions"  

  - name: Install php packages
    shell: "apk add --update {{item}}"
    with_items:
      - "{{php_extensions}}"

  - name: Install Ð¡omposer
    shell: apk add --update curl &&  curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/bin/composer

  - name: Patch /etc/php5/php-fpm.conf
    shell: sed -i "{{item}}" /etc/php5/php-fpm.conf
    with_items:
      - "s|;*daemonize\\s*=\\s*yes|daemonize = no|g"
      - "s|;*listen\\s*=\\s*127.0.0.1:9000|listen = 9000|g"
      - "s|;*listen\\s*=\\s*/||g"

  - name: Patch /etc/php5/php.ini
    shell: sed -i "{{item}}" /etc/php5/php.ini
    with_items:
      - "s|;*date.timezone =.*|date.timezone = {{timezone}}|i"
      - "s|;*memory_limit =.*|memory_limit = {{php_memory_limit | default('512M')}}|i"
      - "s|;*upload_max_filesize =.*|upload_max_filesize = {{php_upload_max_file_size|default('100M')}}|i"
      - "s|;*max_file_uploads =.*|max_file_uploads = {{php_max_file_upload|default('100M')}}|i"
      - "s|;*post_max_size =.*|post_max_size = {{php_post_max_size|default('100M')}}|i"
      - "s|;*cgi.fix_pathinfo=.*|cgi.fix_pathinfo= 0|i"

  - name: Application dir
    file: path="{{app_dir | default('/www')}}" state="directory"

  - name:  Template entrypoinmt
    template: src="entrypoint.sh.j2" dest="/entrypoint.sh" mode="u=rwx,g=rx,o=rx"

  - name: Cleaning up
    shell: |
      	apk del tzdata && \
      	rm -rf /var/cache/apk/*
